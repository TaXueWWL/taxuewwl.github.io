
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>自己写分布式调度组件shield-job之使用shield-job | 朝·闻·道</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="SnoWalker">
    

    <meta name="keywords" content="自己写分布式组件系列">
    <meta name="description" content="自己写分布式调度组件继续更新，目前已经完成了一个里程碑版本。
千呼万唤始出来，却不是当初想的模样。之前立的flag太大，最终决定暂时放弃开发分布式版本，把目标改为基于消息队列RocketMQ的任务分发框架，具体的调度逻辑由调用方自行开发。
客户端接口
首先介绍客户端需要关注的接口以及实体

客户端实体–任务实体BaseJob任务实体BaseJob为shield-job的调度核心实体，调用方的业务实">
<meta property="og:type" content="article">
<meta property="og:title" content="自己写分布式调度组件shield-job之使用shield-job">
<meta property="og:url" content="http://wuwenliang.net/2019/04/15/自己写分布式调度组件shield-job之使用shield-job/index.html">
<meta property="og:site_name" content="朝·闻·道">
<meta property="og:description" content="自己写分布式调度组件继续更新，目前已经完成了一个里程碑版本。
千呼万唤始出来，却不是当初想的模样。之前立的flag太大，最终决定暂时放弃开发分布式版本，把目标改为基于消息队列RocketMQ的任务分发框架，具体的调度逻辑由调用方自行开发。
客户端接口
首先介绍客户端需要关注的接口以及实体

客户端实体–任务实体BaseJob任务实体BaseJob为shield-job的调度核心实体，调用方的业务实">
<meta property="og:image" content="http://wuwenliang.net/2019/04/15/自己写分布式调度组件shield-job之使用shield-job/./structure.png">
<meta property="og:updated_time" content="2019-04-16T08:19:01.758Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="自己写分布式调度组件shield-job之使用shield-job">
<meta name="twitter:description" content="自己写分布式调度组件继续更新，目前已经完成了一个里程碑版本。
千呼万唤始出来，却不是当初想的模样。之前立的flag太大，最终决定暂时放弃开发分布式版本，把目标改为基于消息队列RocketMQ的任务分发框架，具体的调度逻辑由调用方自行开发。
客户端接口
首先介绍客户端需要关注的接口以及实体

客户端实体–任务实体BaseJob任务实体BaseJob为shield-job的调度核心实体，调用方的业务实">
<meta name="twitter:image" content="http://wuwenliang.net/2019/04/15/自己写分布式调度组件shield-job之使用shield-job/./structure.png">

    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="朝·闻·道" title="朝·闻·道"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="朝·闻·道">朝·闻·道</a></h1>
				<h2 class="blog-motto">SnoWalker&#39;s Blog</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/index.html">主页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="/old/index.html">旧版</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:wuwenliang.net">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/04/15/自己写分布式调度组件shield-job之使用shield-job/" title="自己写分布式调度组件shield-job之使用shield-job" itemprop="url">自己写分布式调度组件shield-job之使用shield-job</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="SnoWalker" target="_blank" itemprop="author">SnoWalker</a>
		
  <p class="article-time">
    <time datetime="2019-04-15T02:11:46.000Z" itemprop="datePublished"> 发表于 2019-04-15</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#客户端接口"><span class="toc-number">1.</span> <span class="toc-text">客户端接口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#客户端实体–任务实体BaseJob"><span class="toc-number">1.1.</span> <span class="toc-text">客户端实体–任务实体BaseJob</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#客户端接口-任务生产"><span class="toc-number">1.2.</span> <span class="toc-text">客户端接口-任务生产</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#JobProducerExecutor"><span class="toc-number">1.2.1.</span> <span class="toc-text">JobProducerExecutor</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JobProducerListener"><span class="toc-number">1.2.2.</span> <span class="toc-text">JobProducerListener</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#客户端接口–任务消费"><span class="toc-number">1.3.</span> <span class="toc-text">客户端接口–任务消费</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#JobConsumerExecutor"><span class="toc-number">1.3.1.</span> <span class="toc-text">JobConsumerExecutor</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JobConsumerListenerAdapter"><span class="toc-number">1.3.2.</span> <span class="toc-text">JobConsumerListenerAdapter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JobConsumerListener"><span class="toc-number">1.3.3.</span> <span class="toc-text">JobConsumerListener</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#调用实例"><span class="toc-number">2.</span> <span class="toc-text">调用实例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#项目结构"><span class="toc-number">2.1.</span> <span class="toc-text">项目结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#引入shield-job核心依赖，配置RocketMQ"><span class="toc-number">2.2.</span> <span class="toc-text">引入shield-job核心依赖，配置RocketMQ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#调度实例–任务生产者的开发"><span class="toc-number">2.3.</span> <span class="toc-text">调度实例–任务生产者的开发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#调度实例–任务消费者的开发"><span class="toc-number">2.4.</span> <span class="toc-text">调度实例–任务消费者的开发</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#注意"><span class="toc-number">2.4.1.</span> <span class="toc-text">注意</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#调用效果"><span class="toc-number">2.5.</span> <span class="toc-text">调用效果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#小结"><span class="toc-number">3.</span> <span class="toc-text">小结</span></a></li></ol>
		
		</div>
		
		<p>自己写分布式调度组件继续更新，目前已经完成了一个里程碑版本。</p>
<p>千呼万唤始出来，却不是当初想的模样。之前立的flag太大，最终决定暂时放弃开发分布式版本，把目标改为基于消息队列RocketMQ的任务分发框架，具体的调度逻辑由调用方自行开发。</p>
<h2 id="客户端接口"><a href="#客户端接口" class="headerlink" title="客户端接口"></a>客户端接口</h2><blockquote>
<p>首先介绍客户端需要关注的接口以及实体</p>
</blockquote>
<h3 id="客户端实体–任务实体BaseJob"><a href="#客户端实体–任务实体BaseJob" class="headerlink" title="客户端实体–任务实体BaseJob"></a>客户端实体–任务实体BaseJob</h3><p>任务实体BaseJob为shield-job的调度核心实体，调用方的业务实体需要继承该作业抽象类，实现其中的<strong>encode()</strong> 以及 <strong>decode(String msg)</strong> 抽象方法。</p>
<a id="more"></a>
<p>其中：</p>
<p>客户端需要在encode()方法中实现业务对象到String形式的消息体转换，如：</p>
<pre><code>@Override
public String encode() {
    // 组装消息协议头
    ImmutableMap.Builder headerBuilder = new ImmutableMap.Builder&lt;String, String&gt;()
            .put(&quot;version&quot;, this.getVersion())
            .put(&quot;jobTopic&quot;, this.getJobTopic())
            .put(&quot;jobTag&quot;, this.getJobTag())
            .put(&quot;jobBizDesc&quot;, &quot;测试订单协议&quot;)
            .put(&quot;jobProducerGroup&quot;, this.getJobProducerGroup())
            .put(&quot;jobConsumerGroup&quot;, this.getJobConsumerGroup())
            .put(&quot;jobTraceId&quot;, this.getJobTraceId());
    header = headerBuilder.build();

    body = new ImmutableMap.Builder&lt;String, String&gt;()
            .put(&quot;userId&quot;, this.getUserId())
            .put(&quot;userName&quot;, this.getUserName())
            .put(&quot;orderId&quot;, this.getOrderId())
            .build();

    ImmutableMap&lt;String, Object&gt; map = new ImmutableMap.Builder&lt;String, Object&gt;()
            .put(&quot;header&quot;, header)
            .put(&quot;body&quot;, body)
            .build();
    // 返回序列化消息Json串
    String ret_string = null;
    ObjectMapper objectMapper = new ObjectMapper();
    try {
        ret_string = objectMapper.writeValueAsString(map);
    } catch (JsonProcessingException e) {
        LOGGER.error(&quot;消息序列化json异常:&quot;, e);
    }
    return ret_string;
}
</code></pre><p>这里我使用了Guava的ImmutableMap作为消息协议的容器，使用jackson作为Json序列化工具。业务调用方必须将BaseJob的属性逐一填充，否则会在调度过程中抛出参数校验异常。</p>
<p>在decode(String msg)中实现String形式消息体到业务作业对象的转换，如：</p>
<pre><code>@Override
public void decode(String msg) {
    Preconditions.checkNotNull(msg);
    ObjectMapper mapper = new ObjectMapper();
    try {
        JsonNode root = mapper.readTree(msg);
        // header
        this.setVersion(root.get(&quot;header&quot;).get(&quot;version&quot;).asText());
        this.setJobTopic(root.get(&quot;header&quot;).get(&quot;jobTopic&quot;).asText());
        this.setJobTag(root.get(&quot;header&quot;).get(&quot;jobTag&quot;).asText());
        this.setJobBizDesc(root.get(&quot;header&quot;).get(&quot;jobBizDesc&quot;).asText());
        this.setJobProducerGroup(root.get(&quot;header&quot;).get(&quot;jobProducerGroup&quot;).asText());
        this.setJobConsumerGroup(root.get(&quot;header&quot;).get(&quot;jobConsumerGroup&quot;).asText());
        this.setJobTraceId(root.get(&quot;header&quot;).get(&quot;jobTraceId&quot;).asText());
        // body
        this.setUserName(root.get(&quot;body&quot;).get(&quot;userName&quot;).asText());
        this.setOrderId(root.get(&quot;body&quot;).get(&quot;orderId&quot;).asText());
        this.setUserId(root.get(&quot;body&quot;).get(&quot;userId&quot;).asText());
    } catch (IOException e) {
        LOGGER.error(&quot;反序列化消息异常:&quot;, e);
    }
}
</code></pre><p>这里我将入参消息实体转换为对象本身，通过this对内部的属性进行赋值，从而实现字符串形式的消息体到对象的转换。避免代码过长影响阅读，完整的代码在下文会放出。</p>
<h3 id="客户端接口-任务生产"><a href="#客户端接口-任务生产" class="headerlink" title="客户端接口-任务生产"></a>客户端接口-任务生产</h3><blockquote>
<p>这部分的内容为任务生产过程中需要调用的类及接口</p>
</blockquote>
<h4 id="JobProducerExecutor"><a href="#JobProducerExecutor" class="headerlink" title="JobProducerExecutor"></a>JobProducerExecutor</h4><blockquote>
<p>JobProducerExecutor是shield-job的任务生产调度核心，是final类，不允许被继承。</p>
</blockquote>
<table>
<thead>
<tr>
<th style="text-align:left">类名</th>
<th style="text-align:left">方法名</th>
<th style="text-align:left">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">JobProducerExecutor</td>
<td style="text-align:left">JobProducerExecutor init(RocketMQProducerProperty rocketMQProducerProperty)</td>
<td style="text-align:left">初始化任务调度核心类</td>
</tr>
<tr>
<td style="text-align:left">JobProducerExecutor</td>
<td style="text-align:left">Result<jobsendresult> execute(final JobProducerListener jobProducerListener,Object arg)</jobsendresult></td>
<td style="text-align:left">执行Job生产逻辑，投递Job消息到MQ中。业务方需要实现JobProducerListener的任务生产回调方法</td>
</tr>
<tr>
<td style="text-align:left">JobProducerExecutor</td>
<td style="text-align:left">void start() throws MQClientException</td>
<td style="text-align:left">启动内置的RocketMQ消息生产者,开启任务投递</td>
</tr>
<tr>
<td style="text-align:left">JobProducerExecutor</td>
<td style="text-align:left">DefaultMQProducer getProducer()</td>
<td style="text-align:left">获取RocketMQ生产者引用</td>
</tr>
<tr>
<td style="text-align:left">RocketMQConsumerProperty</td>
<td style="text-align:left">构造方法</td>
<td style="text-align:left">构造RocketMQ生产者实例配置参数</td>
</tr>
</tbody>
</table>
<h4 id="JobProducerListener"><a href="#JobProducerListener" class="headerlink" title="JobProducerListener"></a>JobProducerListener</h4><blockquote>
<p>JobProducerListener是作业生产者接口，客户端的作业生产者需要实现该接口，传入需要进行任务调度的作业实体列表（参数泛型继承BaseJob）</p>
</blockquote>
<table>
<thead>
<tr>
<th style="text-align:left">类名</th>
<th style="text-align:left">方法名</th>
<th style="text-align:left">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">JobProducerListener<t extends="" basejob=""></t></td>
<td style="text-align:left">List<t> produce(final Object arg)</t></td>
<td style="text-align:left">作业调度生产者返回待调度的业务实体协议列表，shield-job会回调该方法并将业务协议列表投递到MQ供作业消费者进行消费</td>
</tr>
</tbody>
</table>
<p>对于非BaseJob的子类，编译阶段即失败。</p>
<h3 id="客户端接口–任务消费"><a href="#客户端接口–任务消费" class="headerlink" title="客户端接口–任务消费"></a>客户端接口–任务消费</h3><blockquote>
<p>这部分为任务调度消费过程涉及到的类及接口</p>
</blockquote>
<h4 id="JobConsumerExecutor"><a href="#JobConsumerExecutor" class="headerlink" title="JobConsumerExecutor"></a>JobConsumerExecutor</h4><blockquote>
<p>JobConsumerExecutor是shield-job的任务消费调度核心，是final类，不允许被继承。</p>
</blockquote>
<table>
<thead>
<tr>
<th style="text-align:left">类名</th>
<th style="text-align:left">方法名</th>
<th style="text-align:left">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">JobConsumerExecutor</td>
<td style="text-align:left">JobConsumerExecutor execute(RocketMQConsumerProperty rocketMQConsumerProperty,JobConsumerListenerAdapter jobConsumerListenerAdapter)</td>
<td style="text-align:left">初始化任务消费核心，执行任务消费调度过程</td>
</tr>
<tr>
<td style="text-align:left">JobConsumerExecutor</td>
<td style="text-align:left">void start() throws MQClientException</td>
<td style="text-align:left">启动内置的RocketMQ消息消费者，开启任务消费</td>
</tr>
<tr>
<td style="text-align:left">RocketMQProducerProperty</td>
<td style="text-align:left">构造方法</td>
<td style="text-align:left">构造RocketMQ消费者实例配置参数</td>
</tr>
</tbody>
</table>
<h4 id="JobConsumerListenerAdapter"><a href="#JobConsumerListenerAdapter" class="headerlink" title="JobConsumerListenerAdapter"></a>JobConsumerListenerAdapter</h4><blockquote>
<p>JobConsumerListenerAdapter是shield-job的任务消费监听适配器，通过调用不同的构造方法决定是否进行消费失败消息的重投递</p>
</blockquote>
<table>
<thead>
<tr>
<th style="text-align:left">类名</th>
<th style="text-align:left">方法名</th>
<th style="text-align:left">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">JobConsumerListenerAdapter</td>
<td style="text-align:left">JobConsumerListenerAdapter(JobConsumerListener jobConsumerListener)</td>
<td style="text-align:left">任务消费适配器默认构造，只进行消费不进行消息重发</td>
</tr>
<tr>
<td style="text-align:left">JobConsumerListenerAdapter</td>
<td style="text-align:left">JobConsumerListenerAdapter(JobConsumerListener jobConsumerListener,JobScheduleExecutorConfig jobScheduleExecutorConfig)</td>
<td style="text-align:left">任务消费适配器带重发构造，既进行消费又进行消息重发</td>
</tr>
<tr>
<td style="text-align:left">JobConsumerListenerAdapter</td>
<td style="text-align:left">ConsumeConcurrentlyStatus consumeMessage(List<messageext> msgs,ConsumeConcurrentlyContext context)</messageext></td>
<td style="text-align:left">任务消费核心接口，客户端消费者调用该方法，shield-job根据构造传参自行决定是直接消费还是需要进行消息重发</td>
</tr>
</tbody>
</table>
<h4 id="JobConsumerListener"><a href="#JobConsumerListener" class="headerlink" title="JobConsumerListener"></a>JobConsumerListener</h4><blockquote>
<p>JobConsumerListener是任务消费监听器接口，消费者需要实现consumeMessage方法，完成消息的消费</p>
</blockquote>
<table>
<thead>
<tr>
<th style="text-align:left">类名</th>
<th style="text-align:left">方法名</th>
<th style="text-align:left">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">JobConsumerListener</td>
<td style="text-align:left">ConsumeConcurrentlyStatus consumeMessage(final List<messageext> msgs, final ConsumeConcurrentlyContext context)</messageext></td>
<td style="text-align:left">消息消费，该方法为标准的RocektMQ消费接口</td>
</tr>
</tbody>
</table>
<h2 id="调用实例"><a href="#调用实例" class="headerlink" title="调用实例"></a>调用实例</h2><p>上述列出的类及其方法即shield-job任务调度的核心接口，直接看确实不直观，这里我用一个实例去讲解下如何在Spring Boot 2.1.2 Release中整合shield-job实现发布订阅模式的任务调度。</p>
<h3 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h3><blockquote>
<p>项目结构如下</p>
</blockquote>
<p><img src="/2019/04/15/自己写分布式调度组件shield-job之使用shield-job/./structure.png" alt="shield-job-springboot-demo"></p>
<h3 id="引入shield-job核心依赖，配置RocketMQ"><a href="#引入shield-job核心依赖，配置RocketMQ" class="headerlink" title="引入shield-job核心依赖，配置RocketMQ"></a>引入shield-job核心依赖，配置RocketMQ</h3><p>首先引入shield-job核心的坐标，需要自行打包并安装到本地，有条件的可以运行 <strong>mvn clean deploy -DskipTests</strong> 直接发布到私服中。</p>
<p>坐标如下：</p>
<pre><code>&lt;dependency&gt;
    &lt;artifactId&gt;shield-job-scheduler-core&lt;/artifactId&gt;
    &lt;groupId&gt;com.snowalker.shield.job&lt;/groupId&gt;
    &lt;version&gt;1.0.0&lt;/version&gt;
&lt;/dependency&gt;
</code></pre><p>由于shield-job核心通过RocketMQ作为任务队列，因此需要在调用方的配置文件中配置RocketMQ的NameServer地址，例如：</p>
<pre><code>########################################################################
#
#     RocketMQ配置
#
#########################################################################
rocketmq.nameServer=192.168.1.107:9876
</code></pre><h3 id="调度实例–任务生产者的开发"><a href="#调度实例–任务生产者的开发" class="headerlink" title="调度实例–任务生产者的开发"></a>调度实例–任务生产者的开发</h3><blockquote>
<p>首先进行业务层任务生产者的开发。</p>
</blockquote>
<p>定义一个名为OrderInfoJobProducer的类，并标记为Spring的bean</p>
<pre><code>@Component
public class OrderInfoJobProducer {

    private static final Logger LOGGER = LoggerFactory.getLogger(OrderInfoJobProducer.class);
</code></pre><p>定义任务发布的MQ的Topic、业务Tag（无tag可以不写）、生产者组、消费者组等参数</p>
<pre><code>/**
* 测试订单任务TOPIC
*/
private static final String TOPIC = &quot;SNOWALKER_TEST_SHIELD_JOB_TOPIC&quot;;
/**
* 测试订单任务TAG
*/
private static final String TAG = &quot;SNOWALKER_TEST_SHIELD_JOB_TAG&quot;;
/**
* 测试订单生产者组
*/
private static final String PRODUCER_GROUP = &quot;PID_SNOWALKER_TEST_SHIELD_JOB&quot;;
/**
* 测试订单消费者组
*/
private static final String CONSUMER_GROUP = &quot;CID_SNOWALKER_TEST_SHIELD_JOB&quot;;
</code></pre><p>读入配置文件中的RocketMQ的NameServer地址</p>
<pre><code>@Value(&quot;${rocketmq.nameServer}&quot;)
private String nameSrvAddr;
</code></pre><p>声明shield-job的任务生产者执行器JobProducerExecutor</p>
<pre><code>private JobProducerExecutor jobProducerExecutor;
</code></pre><p>通过@PostConstruct方式初始化JobProducerExecutor并开启运行内部的生产者</p>
<pre><code>@PostConstruct
public void init() throws MQClientException {
    // 实例化作业生产调度器
    jobProducerExecutor = new JobProducerExecutor()
            .init(new RocketMQProducerProperty(PRODUCER_GROUP,nameSrvAddr));
    jobProducerExecutor.getProducer().start();
}
</code></pre><p>核心调度逻辑，这里可以选用任意的调度框架，此处为spring-scheduler方式，通过 @Scheduled 注解声明此处为定时任务调度核心，并引入配置文件中的cron表达式，示例中的cron表达式为 <strong>0/3 <em> </em> <em> </em> ?</strong>  表示从0S开始，每次调度之间间隔三秒</p>
<pre><code>@Scheduled(cron = &quot;${order.resend.cron}&quot;)
public void execute() {
    try {
        // 传入JobProducerListener实现类，返回作业实体
        Result&lt;JobSendResult&gt; jobSendResult = jobProducerExecutor.execute(
</code></pre><p>此处通过匿名内部类的方式实现了JobProducerListener的回调方法 <strong>produce(Object arg)</strong> 将业务层拼装的业务订单调度协议（OrderInfoJobProcotol继承BaseJob）封装在 List<orderinfojobprocotol> 中，供JobProducerExecutor进行回调，提交任务至RocketMQ中。</orderinfojobprocotol></p>
<pre><code>(new JobProducerListener() {
    @Override
    public List produce(Object arg) {
        List&lt;OrderInfoJobProcotol&gt; jobs = new ArrayList&lt;&gt;(10);
        for (int i = 0; i &lt; 1; i++) {
            OrderInfoJobProcotol orderInfoJobProcotol = new OrderInfoJobProcotol();
            orderInfoJobProcotol.setOrderId(&quot;OD_&quot; + UUID.randomUUID().toString())
                    .setUserId(&quot;SNOWALKER_&quot; + UUID.randomUUID().toString())
                    .setUserName(&quot;SNOWALKER_&quot; + i)
                    .setJobTraceId(&quot;TRACE_&quot; + UUID.randomUUID().toString())
                    .setJobTopic(TOPIC)
                    .setJobTag(TAG)
                    .setJobProducerGroup(PRODUCER_GROUP)
                    .setJobConsumerGroup(CONSUMER_GROUP)
            ;
            jobs.add(orderInfoJobProcotol);
        }
        return jobs;
    }
}), null);
</code></pre><p>这里可以根据返回的 <strong>Result</strong> 对返回的任务提交实体进行更多的操作。JobSendResult中包含了每一次调度中提交成功的任务列表 <strong>sendSuccessJobList</strong> 以及 提交失败的任务列表 <strong>sendFailureJobList</strong>，业务层可以解析这两个列表，进行诸如重发、落库等更多的业务操作。</p>
<pre><code>        if (jobSendResult == null) {
            LOGGER.warn(&quot;执行作业分发失败,返回为空,topic={}&quot;, TOPIC);
        }
        if (jobSendResult.isSuccess()) {
            LOGGER.info(&quot;执行作业分发成功,jobSendResult={}&quot;, jobSendResult.toString());
        }
    } catch (Exception e) {
        LOGGER.error(&quot;执行作业分发异常&quot;, e);
    }
}
</code></pre><p>}</p>
<p>到此就完成了业务层的任务生产者的开发。</p>
<h3 id="调度实例–任务消费者的开发"><a href="#调度实例–任务消费者的开发" class="headerlink" title="调度实例–任务消费者的开发"></a>调度实例–任务消费者的开发</h3><blockquote>
<p>接着进行业务层任务消费者的开发。</p>
</blockquote>
<p>首先定义一个业务任务消费者类OrderInfoJobConsumer，标记为Spring的bean。</p>
<pre><code>@Component
public class OrderInfoJobConsumer {

    private static final Logger LOGGER = LoggerFactory.getLogger(OrderInfoJobConsumer.class);
</code></pre><p>声明需要进行订阅的topic、tag（默认为*）、消费者组</p>
<pre><code>/**测试订单任务TOPIC*/
private static final String TOPIC = &quot;SNOWALKER_TEST_SHIELD_JOB_TOPIC&quot;;
/**测试订单任务TAG*/
private static final String TAG = &quot;SNOWALKER_TEST_SHIELD_JOB_TAG&quot;;
/**测试订单生产者组*/
private static final String CONSUMER_GROUP = &quot;CID_SNOWALKER_TEST_SHIELD_JOB&quot;;
</code></pre><p>引入配置文件中配置的RocketMQ的nameServer地址</p>
<pre><code>@Value(&quot;${rocketmq.nameServer}&quot;)
private String nameSrvAddr;
</code></pre><p>如果需要在消费失败后，进行消息重发，那么需要引入RedisTemplate，不引入则表示不需要框架做消息重发，业务层自行处理消费失败的逻辑。</p>
<pre><code>@Autowired
RedisTemplate redisTemplate;
</code></pre><p>通过@PostConstruct方式启动任务消费者实例，并实现任务消费逻辑，此处为默认不需要框架进行消费失败后重发job消息的业务逻辑书写方式</p>
<p>@PostConstruct<br>    public void execute() throws Exception {</p>
<pre><code>    // 不需要重发
    new JobConsumerExecutor().execute(
            new RocketMQConsumerProperty(
                    TOPIC, CONSUMER_GROUP, nameSrvAddr, TAG),
                        new JobConsumerListenerAdapter(new JobConsumerListener() {
                            @Override
                            public ConsumeConcurrentlyStatus consumeMessage(List&lt;MessageExt&gt; msgs, ConsumeConcurrentlyContext context) {
                                try {
                                    String msgId = &quot;&quot;;
                                    String msgBody = &quot;&quot;;
                                    // 默认msgs只有一条消息
                                    for (MessageExt msg : msgs) {
                                        String message = new String(msg.getBody());
                                        OrderInfoJobProcotol protocol = new OrderInfoJobProcotol();
                                        protocol.decode(message);
                                        // 解析打印实体
                                        msgId = msg.getMsgId();
                                        msgBody = message;
                                    }
                                    LOGGER.info(&quot;模拟订单Job消息消费逻辑结束,状态--[RECONSUME_LATER]--msgId={}&quot;, msgId);

                                    return ConsumeConcurrentlyStatus.RECONSUME_LATER;
                                } catch (Exception e) {
                                    LOGGER.error(&quot;钱包扣款消费异常,e={}&quot;, e);
                                    return ConsumeConcurrentlyStatus.RECONSUME_LATER;
                                }
                            }
                        })).start();
}
</code></pre><p>可以看到，我们需要做的事情为：</p>
<ol>
<li>实例化一个任务消费执行器JobConsumerExecutor</li>
<li>调用execute方法，传入RocketMQConsumerProperty实例</li>
<li>execute的第二个参数为JobConsumerListenerAdapter实例，它接受一个参数JobConsumerListener，这里我们需要实现JobConsumerListener接口，并将具体的实现的引用传入JobConsumerListenerAdapter构造方法</li>
<li>实现consumeMessage方法，将消费状态ConsumeConcurrentlyStatus返回。shield-job会代理真实的RocketMQ的MessageListenerConcurrently接口，将消费状态返给RocketMQ，效果同直接使用RocketMQ的DefaultMQPushConsumer进行消费相同。</li>
</ol>
<p>如果我们使用JobConsumerListenerAdapter的另外一个构造方法，<strong>JobConsumerListenerAdapter(JobConsumerListener jobConsumerListener,JobScheduleExecutorConfig jobScheduleExecutorConfig)</strong> ，该构造方法表示需要对消费失败的消息进行消息重发，那么shield-job会对消费状态ConsumeConcurrentlyStatus进行解析，并对达到重试阈值且重发次数小于3的消息进行消息存储并开启异步线程进行重投递，具体代码如下：</p>
<pre><code>@PostConstruct
public void execute1() throws Exception {

    JobScheduleExecutorConfig jobScheduleExecutorConfig =
            new JobScheduleExecutorConfig(1,
                    nameSrvAddr,
                    new MessageStoreRedisTemplate(redisTemplate),
                    Executors.newScheduledThreadPool(10),
                    0,
                    3,
                    TimeUnit.SECONDS);

    // 需要消息重发
    new JobConsumerExecutor().execute(
            new RocketMQConsumerProperty(
                    TOPIC, CONSUMER_GROUP, nameSrvAddr, TAG),
            new JobConsumerListenerAdapter(new JobConsumerListener() {
                @Override
                public ConsumeConcurrentlyStatus consumeMessage(List&lt;MessageExt&gt; msgs, ConsumeConcurrentlyContext context) {
                    return getConsumeConcurrentlyStatus(msgs);
                }
            }, jobScheduleExecutorConfig)).start();
}
</code></pre><p>可以看到，我们需要构造并实例化任务重发配置JobScheduleExecutorConfig，并将其传入JobConsumerListenerAdapter的构造方法中。</p>
<h4 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h4><p>目前该功能还处于进一步测试阶段，因此建议还是使用 <strong>JobConsumerListenerAdapter(JobConsumerListener jobConsumerListener)</strong> 进行JobConsumerListenerAdapter的实例化。</p>
<h3 id="调用效果"><a href="#调用效果" class="headerlink" title="调用效果"></a>调用效果</h3><blockquote>
<p>到这里，我们就完成了业务模块对shield-job的整合及调度任务的开发，运行一下程序看一下执行效果。</p>
</blockquote>
<p>首先保证业务系统到RocektMQ的连通，执行启动方法，查看到日志如下：</p>
<pre><code>2019-04-15 14:16:11.188 [main] INFO  c.s.shield.job.consumer.JobConsumerExecutor [45]
- JobConsumerExecuter init successfully, topic=SNOWALKER_TEST_SHIELD_JOB_TOPIC, consumerGroup=CID_SNOWALKER_TEST_SHIELD_JOB
2019-04-15 14:16:13.794 [main] INFO  c.s.shield.job.producer.JobProducerExecutor [56] 
- JobProducerExecutor init successfully, jobProducerGroup=PID_SNOWALKER_TEST_SHIELD_JOB
......
2019-04-15 14:16:14.406 [main] INFO  com.snowalker.shield.jobdemo.App [59] 
- Started App in 6.482 seconds (JVM running for 7.747)
2019-04-15 14:16:14.407 [main] INFO  com.snowalker.shield.jobdemo.App [26] 
- shield-job-server启动完成......
2019-04-15 14:16:15.577 [scheduling-1] DEBUG c.s.shield.job.producer.JobProducerExecutor [100] 
- send job message successful, message sendStatus=SEND_OK, msgId=AC1E534751682437C6DC4B28F5D30000, queueOffset=142, transactionId=null, offsetMsgId=AC1E423300002A9F000000000059D06E, regionId=DefaultRegion, sendSuccessJobList.size()=0
2019-04-15 14:16:15.578 [scheduling-1] INFO  c.s.shield.job.producer.JobProducerExecutor [121] 
- send job messages finished, sendSuccessJobList messages size=1, sendFailureJobList messages size=0, topic=SNOWALKER_TEST_SHIELD_JOB_TOPIC, tag=SNOWALKER_TEST_SHIELD_JOB_TAG
2019-04-15 14:16:15.578 [scheduling-1] INFO  c.s.shield.jobdemo.producer.OrderInfoJobProducer [93] 
- 执行作业分发成功,jobSendResult=Result{code=200, message=&apos;SUCCESS&apos;, content=JobSendResult{sendSuccessJobList=[BaseJob{version=&apos;1.0&apos;, jobTopic=&apos;SNOWALKER_TEST_SHIELD_JOB_TOPIC&apos;, jobTag=&apos;SNOWALKER_TEST_SHIELD_JOB_TAG&apos;, jobBizDesc=&apos;null&apos;, jobProducerGroup=&apos;PID_SNOWALKER_TEST_SHIELD_JOB&apos;, jobConsumerGroup=&apos;CID_SNOWALKER_TEST_SHIELD_JOB&apos;, jobTraceId=&apos;TRACE_cbdb715e-173b-4adc-b0ed-1a1a1aea689c&apos;, jobMsgId=&apos;AC1E534751682437C6DC4B28F5D30000&apos;, params=null}], sendFailureJobList=[]}}
2019-04-15 14:16:16.454 [ConsumeMessageThread_8] INFO  c.s.shield.jobdemo.consumer.OrderInfoJobConsumer [100] 
- 模拟订单Job消息消费逻辑结束,状态--[RECONSUME_LATER]--msgId=AC1E534751682437C6DC4B28F5D30000
</code></pre><p>由于我们的调度生产者和消费者在同一个应用内，因此属于 <strong>“自产自销”</strong> 的模式，模拟的订单作业消息投递到MQ之后，下发至当前应用的消费者，被消费者处理。</p>
<p>返回RECONSUME_LATER是笔者为了测试重发，在实际业务中，当作业消费成功，直接返回 <strong>ConsumeConcurrentlyStatus.CONSUME_SUCCESS</strong> 即可。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>到此，我们就完成了使用shield-job实现业务上的任务调度逻辑的整合过程。代码地址为: <a href="https://github.com/TaXueWWL/shield-job" target="_blank" rel="external">shield-job</a>。</p>
<p>后续的文章中，我将对shield-job的实现方式抽丝剥茧，将我在开发过程中的感悟、思考以及一些编码技巧进行进一步的分享。</p>
<blockquote>
<p>昨夜西风凋碧树。独上高楼，望尽天涯路。</p>
</blockquote>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/自己写分布式组件系列/">自己写分布式组件系列</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/自己写分布式组件系列/">自己写分布式组件系列</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://wuwenliang.net/2019/04/15/自己写分布式调度组件shield-job之使用shield-job/" data-title="自己写分布式调度组件shield-job之使用shield-job | 朝·闻·道" data-tsina="null" class="share clearfix">
	  </div>
	
	</div>


</footer>

   
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2019/04/16/自己写分布式调度组件shield-job之使用单机模式/" title="自己写分布式调度组件shield-job之使用单机模式">
  <strong>上一篇：</strong><br/>
  <span>
  自己写分布式调度组件shield-job之使用单机模式</span>
</a>
</div>


<div class="next">
<a href="/2019/03/28/跟我学RocketMQ之消息幂等/"  title="跟我学RocketMQ之消息幂等">
 <strong>下一篇：</strong><br/> 
 <span>跟我学RocketMQ之消息幂等
</span>
</a>
</div>

</nav>

	
<section id="comments" class="comment">
	<div class="ds-thread" data-thread-key="2019/04/15/自己写分布式调度组件shield-job之使用shield-job/" data-title="自己写分布式调度组件shield-job之使用shield-job" data-url="http://wuwenliang.net/2019/04/15/自己写分布式调度组件shield-job之使用shield-job/"></div>
</section>




</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#客户端接口"><span class="toc-number">1.</span> <span class="toc-text">客户端接口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#客户端实体–任务实体BaseJob"><span class="toc-number">1.1.</span> <span class="toc-text">客户端实体–任务实体BaseJob</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#客户端接口-任务生产"><span class="toc-number">1.2.</span> <span class="toc-text">客户端接口-任务生产</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#JobProducerExecutor"><span class="toc-number">1.2.1.</span> <span class="toc-text">JobProducerExecutor</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JobProducerListener"><span class="toc-number">1.2.2.</span> <span class="toc-text">JobProducerListener</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#客户端接口–任务消费"><span class="toc-number">1.3.</span> <span class="toc-text">客户端接口–任务消费</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#JobConsumerExecutor"><span class="toc-number">1.3.1.</span> <span class="toc-text">JobConsumerExecutor</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JobConsumerListenerAdapter"><span class="toc-number">1.3.2.</span> <span class="toc-text">JobConsumerListenerAdapter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JobConsumerListener"><span class="toc-number">1.3.3.</span> <span class="toc-text">JobConsumerListener</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#调用实例"><span class="toc-number">2.</span> <span class="toc-text">调用实例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#项目结构"><span class="toc-number">2.1.</span> <span class="toc-text">项目结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#引入shield-job核心依赖，配置RocketMQ"><span class="toc-number">2.2.</span> <span class="toc-text">引入shield-job核心依赖，配置RocketMQ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#调度实例–任务生产者的开发"><span class="toc-number">2.3.</span> <span class="toc-text">调度实例–任务生产者的开发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#调度实例–任务消费者的开发"><span class="toc-number">2.4.</span> <span class="toc-text">调度实例–任务消费者的开发</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#注意"><span class="toc-number">2.4.1.</span> <span class="toc-text">注意</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#调用效果"><span class="toc-number">2.5.</span> <span class="toc-text">调用效果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#小结"><span class="toc-number">3.</span> <span class="toc-text">小结</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/CouchDB/" title="CouchDB">CouchDB<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/DDD/" title="DDD">DDD<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Dubbo/" title="Dubbo">Dubbo<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/ELK-Stack/" title="ELK-Stack">ELK-Stack<sup>7</sup></a></li>
		  
		
		  
			<li><a href="/categories/HTTPS/" title="HTTPS">HTTPS<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Hexo/" title="Hexo">Hexo<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/JDK-concurrent/" title="JDK-concurrent">JDK-concurrent<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/JDK源码解析/" title="JDK源码解析">JDK源码解析<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Java/" title="Java">Java<sup>34</sup></a></li>
		  
		
		  
			<li><a href="/categories/KindEditor/" title="KindEditor">KindEditor<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Linux/" title="Linux">Linux<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Redis/" title="Redis">Redis<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/SSO/" title="SSO">SSO<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Sharding-JDBC/" title="Sharding-JDBC">Sharding-JDBC<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/SpringCloud/" title="SpringCloud">SpringCloud<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/TCC-Transaction源码解析/" title="TCC-Transaction源码解析">TCC-Transaction源码解析<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Tomcat/" title="Tomcat">Tomcat<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/auth/" title="auth">auth<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/docker/" title="docker">docker<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/hexo/" title="hexo">hexo<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/kubernates/" title="kubernates">kubernates<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/maven/" title="maven">maven<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/mybatis/" title="mybatis">mybatis<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/mysql/" title="mysql">mysql<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/nginx/" title="nginx">nginx<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/nginx-负载均衡/" title="nginx, 负载均衡">nginx, 负载均衡<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/spring-boot/" title="spring-boot">spring-boot<sup>38</sup></a></li>
		  
		
		  
			<li><a href="/categories/springboot/" title="springboot">springboot<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/web/" title="web">web<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/与你同行/" title="与你同行">与你同行<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/专题-分布式/" title="专题-分布式">专题-分布式<sup>16</sup></a></li>
		  
		
		  
			<li><a href="/categories/从零学Netty/" title="从零学Netty">从零学Netty<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/代理模式-工作总结-入职感受/" title="代理模式,工作总结,入职感受">代理模式,工作总结,入职感受<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/分布式-Dubbo/" title="分布式 Dubbo">分布式 Dubbo<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/单例模式/" title="单例模式">单例模式<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/实战分布式/" title="实战分布式">实战分布式<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/年度总结/" title="年度总结">年度总结<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/数据库/" title="数据库">数据库<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/架构/" title="架构">架构<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/汇总盘点推荐/" title="汇总盘点推荐">汇总盘点推荐<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/爬虫/" title="爬虫">爬虫<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/电话面试/" title="电话面试">电话面试<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/研磨Kafka/" title="研磨Kafka">研磨Kafka<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/自己写分布式组件系列/" title="自己写分布式组件系列">自己写分布式组件系列<sup>17</sup></a></li>
		  
		
		  
			<li><a href="/categories/跟我学RocketMQ/" title="跟我学RocketMQ">跟我学RocketMQ<sup>25</sup></a></li>
		  
		
		  
			<li><a href="/categories/跟我学zookeeper/" title="跟我学zookeeper">跟我学zookeeper<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/随笔/" title="随笔">随笔<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/音视频/" title="音视频">音视频<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
  <div class="tagcloudlist">
    <p class="asidetitle">标签云</p>
    <div class="tagcloudlist clearfix">
       <a href="/tags/CouchDB/" style="font-size: 10px;">CouchDB</a> <a href="/tags/DDD/" style="font-size: 12.73px;">DDD</a> <a href="/tags/Dubbo/" style="font-size: 12.73px;">Dubbo</a> <a href="/tags/ELK-Stack/" style="font-size: 15.45px;">ELK-Stack</a> <a href="/tags/HTTPS/" style="font-size: 10px;">HTTPS</a> <a href="/tags/Hexo/" style="font-size: 10px;">Hexo</a> <a href="/tags/JDK-concurrent/" style="font-size: 12.73px;">JDK-concurrent</a> <a href="/tags/JDK源码解析/" style="font-size: 12.73px;">JDK源码解析</a> <a href="/tags/Java/" style="font-size: 19.09px;">Java</a> <a href="/tags/KindEditor/" style="font-size: 10px;">KindEditor</a> <a href="/tags/Linux/" style="font-size: 10.91px;">Linux</a> <a href="/tags/Redis/" style="font-size: 10px;">Redis</a> <a href="/tags/SSO-单点登录/" style="font-size: 10px;">SSO,单点登录</a> <a href="/tags/Sharding-JDBC/" style="font-size: 12.73px;">Sharding-JDBC</a> <a href="/tags/SpringCloud/" style="font-size: 10px;">SpringCloud</a> <a href="/tags/TCC-Transaction源码解析/" style="font-size: 10.91px;">TCC-Transaction源码解析</a> <a href="/tags/Tomcat/" style="font-size: 10.91px;">Tomcat</a> <a href="/tags/auth/" style="font-size: 10.91px;">auth</a> <a href="/tags/docker/" style="font-size: 11.82px;">docker</a> <a href="/tags/hexo/" style="font-size: 10.91px;">hexo</a> <a href="/tags/kubernates/" style="font-size: 10px;">kubernates</a> <a href="/tags/maven/" style="font-size: 11.82px;">maven</a> <a href="/tags/mybatis/" style="font-size: 10.91px;">mybatis</a> <a href="/tags/mysql/" style="font-size: 13.64px;">mysql</a> <a href="/tags/nginx/" style="font-size: 10.91px;">nginx</a> <a href="/tags/spring-boot/" style="font-size: 20px;">spring-boot</a> <a href="/tags/springboot/" style="font-size: 10px;">springboot</a> <a href="/tags/web/" style="font-size: 12.73px;">web</a> <a href="/tags/与你同行/" style="font-size: 10px;">与你同行</a> <a href="/tags/专题-分布式/" style="font-size: 16.36px;">专题-分布式</a> <a href="/tags/从零学Netty/" style="font-size: 10.91px;">从零学Netty</a> <a href="/tags/代理模式-工作总结-入职感受/" style="font-size: 10px;">代理模式,工作总结,入职感受</a> <a href="/tags/分布式-Dubbo/" style="font-size: 12.73px;">分布式 Dubbo</a> <a href="/tags/单例模式-懒加载/" style="font-size: 10px;">单例模式, 懒加载</a> <a href="/tags/实战分布式/" style="font-size: 11.82px;">实战分布式</a> <a href="/tags/年度总结/" style="font-size: 13.64px;">年度总结</a> <a href="/tags/我们的爱情/" style="font-size: 10px;">我们的爱情</a> <a href="/tags/数据库/" style="font-size: 10px;">数据库</a> <a href="/tags/汇总盘点推荐/" style="font-size: 10px;">汇总盘点推荐</a> <a href="/tags/爬虫-WebMagic/" style="font-size: 10px;">爬虫,WebMagic</a> <a href="/tags/电话面试/" style="font-size: 10px;">电话面试</a> <a href="/tags/研磨Kafka/" style="font-size: 14.55px;">研磨Kafka</a> <a href="/tags/秒杀/" style="font-size: 10px;">秒杀</a> <a href="/tags/自己写分布式组件系列/" style="font-size: 17.27px;">自己写分布式组件系列</a> <a href="/tags/跟我学RocketMQ/" style="font-size: 18.18px;">跟我学RocketMQ</a> <a href="/tags/跟我学zookeeper/" style="font-size: 10px;">跟我学zookeeper</a> <a href="/tags/随笔/" style="font-size: 14.55px;">随笔</a> <a href="/tags/音视频/" style="font-size: 10px;">音视频</a>
    </div>
  </div>


  
<div class="github-card">
<p class="asidetitle">Github 名片</p>
<div class="github-card" data-github="TaXueWWL" data-width="220" data-height="119" data-theme="medium">
<script type="text/javascript" src="//cdn.jsdelivr.net/github-cards/latest/widget.js" ></script>
</div>
  </div>



  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/spring-boot/" title="spring-boot">spring-boot<sup>38</sup></a></li>
			
		
			
				<li><a href="/tags/Java/" title="Java">Java<sup>34</sup></a></li>
			
		
			
				<li><a href="/tags/跟我学RocketMQ/" title="跟我学RocketMQ">跟我学RocketMQ<sup>25</sup></a></li>
			
		
			
				<li><a href="/tags/自己写分布式组件系列/" title="自己写分布式组件系列">自己写分布式组件系列<sup>17</sup></a></li>
			
		
			
				<li><a href="/tags/专题-分布式/" title="专题-分布式">专题-分布式<sup>16</sup></a></li>
			
		
			
				<li><a href="/tags/ELK-Stack/" title="ELK-Stack">ELK-Stack<sup>7</sup></a></li>
			
		
			
				<li><a href="/tags/随笔/" title="随笔">随笔<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/研磨Kafka/" title="研磨Kafka">研磨Kafka<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/mysql/" title="mysql">mysql<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/年度总结/" title="年度总结">年度总结<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/Dubbo/" title="Dubbo">Dubbo<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/DDD/" title="DDD">DDD<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/web/" title="web">web<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/JDK源码解析/" title="JDK源码解析">JDK源码解析<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/JDK-concurrent/" title="JDK-concurrent">JDK-concurrent<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/分布式-Dubbo/" title="分布式 Dubbo">分布式 Dubbo<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Sharding-JDBC/" title="Sharding-JDBC">Sharding-JDBC<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/maven/" title="maven">maven<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/docker/" title="docker">docker<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/实战分布式/" title="实战分布式">实战分布式<sup>3</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="undefined" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=null&verifier=b3593ceb&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p>  <br/>
			惟精惟一，允执厥中 朝闻道，夕死可矣</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		<a href="https://github.com/TaXueWWL" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		<a href="http://www.zhihu.com/people/TaXueWWL" target="_blank" class="icon-zhihu" title="知乎"></a>
		
		
		
		<a href="mailto:wuwenliangsn@gmail.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2021 
		
		<a href="/about" target="_blank" title="SnoWalker">SnoWalker</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>



<script type="text/javascript">
  var duoshuoQuery = {short_name:"snowalker"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 







<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>

<a href="https://github.com/TaXueWWL" target="_blank"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_left_white_ffffff.png" alt="Fork me on GitHub"></a>